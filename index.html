<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>My App — Auth</title>

  <!-- FirebaseUI styles -->
  <link rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/6.1.0/firebase-ui-auth.css" />

  <!-- Firebase compat SDKs (needed for FirebaseUI) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>

  <!-- FirebaseUI (works with compat) -->
  <script src="https://www.gstatic.com/firebasejs/ui/6.1.0/firebase-ui-auth.js"></script>

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
    .card { border: 1px solid #eee; border-radius: 12px; padding: 16px 20px; box-shadow: 0 2px 10px rgba(0,0,0,.04); max-width: 560px; }
    #signed-in { display: none; align-items: center; gap: 12px; }
    #photo { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; display:none; }
    #signout { padding: 8px 12px; border-radius: 10px; border: 1px solid #ddd; background: #fafafa; cursor: pointer; }
    #signout:hover { background: #f0f0f0; }
    #disabled { display:none; color:#b00; margin-top:8px; }
  </style>
</head>
<body>
  <h1>Welcome to My Awesome App</h1>

  <div class="card">
    <!-- Signed-in view -->
    <div id="signed-in">
      <img id="photo" alt="Profile" />
      <div id="welcome"></div>
      <button id="signout" title="Sign out">Sign out</button>
    </div>

    <!-- FirebaseUI login container (shown when signed out) -->
    <div id="firebaseui-auth-container"></div>

    <!-- Message when config is missing (e.g., on GitHub Pages) -->
    <div id="disabled">Authentication is disabled on this public demo.</div>
  </div>

  <script>
    // Try to load the local-only config (exists in localhost dev, missing on GitHub Pages).
    fetch('/firebase-config.local.json', { cache: 'no-store' })
      .then(r => {
        if (!r.ok) throw new Error('No local config present');
        return r.json();
      })
      .then(firebaseConfig => {
        // --- Initialize Firebase (compat) ---
        firebase.initializeApp(firebaseConfig);

        // --- FirebaseUI config ---
        const uiConfig = {
          signInFlow: 'popup',
          signInOptions: [
            firebase.auth.GoogleAuthProvider.PROVIDER_ID,
            firebase.auth.EmailAuthProvider.PROVIDER_ID
          ],
          callbacks: {
            signInSuccessWithAuthResult: function(authResult) {
              renderSignedIn(authResult.user);
              document.getElementById('firebaseui-auth-container').style.display = 'none';
              return false; // stay on this page
            }
          },
          tosUrl: '/tos.html',
          privacyPolicyUrl: '/privacy.html'
        };

        const ui = firebaseui.auth.AuthUI.getInstance() || new firebaseui.auth.AuthUI(firebase.auth());

        // Toggle UI based on auth state
        firebase.auth().onAuthStateChanged(function(user) {
          if (user) {
            renderSignedIn(user);
            document.getElementById('firebaseui-auth-container').style.display = 'none';
          } else {
            document.getElementById('signed-in').style.display = 'none';
            document.getElementById('disabled').style.display = 'none';
            document.getElementById('firebaseui-auth-container').style.display = 'block';
            ui.start('#firebaseui-auth-container', uiConfig);
          }
        });

        // Sign out
        document.getElementById('signout').addEventListener('click', function() {
          firebase.auth().signOut();
        });

        function renderSignedIn(user) {
          const nameOrEmail = user.displayName || user.email || 'Anonymous';
          document.getElementById('welcome').textContent = `Signed in as ${nameOrEmail}`;
          const photo = document.getElementById('photo');
          if (user.photoURL) { photo.src = user.photoURL; photo.style.display = 'inline-block'; }
          else { photo.style.display = 'none'; }
          document.getElementById('signed-in').style.display = 'flex';
        }
      })
      .catch(() => {
        // No config found (e.g., on GitHub Pages) – disable auth gracefully
        document.getElementById('firebaseui-auth-container').style.display = 'none';
        document.getElementById('signed-in').style.display = 'none';
        document.getElementById('disabled').style.display = 'block';
      });
  </script>
</body>
</html>
